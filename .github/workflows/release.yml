name: 同步Releases

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'   # 每4小时一次

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Get latest release from source repo (public)
        id: get_release
        run: |
          SOURCE_REPO="lystv/fmapp"
          API_URL="https://api.github.com/repos/${SOURCE_REPO}/releases/latest"
          RELEASE_JSON=$(curl -s -H "Accept: application/vnd.github.v3+json" "$API_URL")

          TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name // empty')
          if [ -z "$TAG_NAME" ]; then
            echo "No releases found or source repo is private."
            exit 0
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

          # 使用 Heredoc 处理多行 body
          BODY=$(echo "$RELEASE_JSON" | jq -r '.body // ""')
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # 获取 assets 下载 URL
          ASSET_URLS=$(echo "$RELEASE_JSON" | jq -r '.assets[]?.browser_download_url')
          echo "asset_urls<<EOF" >> $GITHUB_OUTPUT
          echo "$ASSET_URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check if release exists in target
        id: check_exist
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.get_release.outputs.tag }}"
          if gh release view "$TAG" --repo ${{ github.repository }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create release in target
        if: steps.check_exist.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.get_release.outputs.tag }}"
          BODY="${{ steps.get_release.outputs.body }}"
          gh release create "$TAG" --repo ${{ github.repository }} --title "$TAG" --notes "$BODY"

      - name: Download and upload assets
        if: steps.check_exist.outputs.exists == 'false'
        run: |
          TAG="${{ steps.get_release.outputs.tag }}"
          mkdir -p ./assets
          cd ./assets

          # 下载 assets
          echo "${{ steps.get_release.outputs.asset_urls }}" | while read url; do
            if [ -n "$url" ]; then
              curl -s -L -O "$url"
            fi
          done

          # 上传 assets
          export GH_TOKEN=${{ github.token }}
          for file in *; do
            if [ -f "$file" ]; then
              gh release upload "$TAG" "$file" --repo ${{ github.repository }} --clobber
            fi
          done
