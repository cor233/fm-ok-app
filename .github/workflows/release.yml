name: 同步 Releases

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  sync-all-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出目标仓库
        uses: actions/checkout@v4

      - name: 获取并排序源仓库的所有 Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="lystv/fmapp"
          PAGE=1
          PER_PAGE=100
          RELEASES_JSON=""
          while true; do
            API_URL="https://api.github.com/repos/${SOURCE_REPO}/releases?per_page=${PER_PAGE}&page=${PAGE}"
            RESPONSE=$(curl -s -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GH_TOKEN" \
              "$API_URL")
            if ! echo "$RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
              echo "错误：API 响应不是数组，退出。"
              echo "响应内容：$RESPONSE"
              exit 1
            fi
            if [ "$(echo "$RESPONSE" | jq length)" -eq 0 ]; then
              break
            fi
            if [ -z "$RELEASES_JSON" ]; then
              RELEASES_JSON="$RESPONSE"
            else
              RELEASES_JSON=$(echo "$RELEASES_JSON" "$RESPONSE" | jq -s 'add')
            fi
            PAGE=$((PAGE + 1))
            sleep 0.5
          done
          RELEASES_JSON=$(echo "$RELEASES_JSON" | jq 'sort_by(.published_at)')
          echo "$RELEASES_JSON" > releases.json

      - name: 按顺序处理每个 Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE_REPO="lystv/fmapp"
          TARGET_REPO="${{ github.repository }}"
          RELEASES_JSON=$(cat releases.json)
          echo "$RELEASES_JSON" | jq -c '.[]' | while read release; do
            TAG_NAME=$(echo "$release" | jq -r '.tag_name')
            BODY=$(echo "$release" | jq -r '.body // ""')
            echo "正在处理 Release: $TAG_NAME"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$TARGET_REPO/releases/tags/$TAG_NAME")
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "Release $TAG_NAME 已存在，跳过。"
              continue
            elif [ "$HTTP_STATUS" -eq 404 ]; then
              echo "Release $TAG_NAME 不存在，继续创建。"
            else
              echo "警告：检查 Release 时返回意外状态码 $HTTP_STATUS，将尝试创建。"
            fi
            echo "$BODY" > body.txt
            if ! gh release create "$TAG_NAME" \
              --repo "$TARGET_REPO" \
              --title "$TAG_NAME" \
              --notes-file body.txt; then
              echo "创建 Release $TAG_NAME 失败，退出。"
              exit 1
            fi
            ASSET_URLS=$(echo "$release" | jq -r '.assets[]?.browser_download_url')
            if [ -n "$ASSET_URLS" ]; then
              TEMP_DIR=$(mktemp -d)
              cd "$TEMP_DIR"
              echo "$ASSET_URLS" | while read url; do
                if [ -n "$url" ]; then
                  echo "下载附件: $url"
                  curl -s -L -O "$url" || echo "下载失败: $url"
                fi
              done
              for file in *; do
                if [ -f "$file" ]; then
                  gh release upload "$TAG_NAME" "$file" --repo "$TARGET_REPO" --clobber
                fi
              done
              cd ..
              rm -rf "$TEMP_DIR"
            fi
            rm -f body.txt
          done
